/*!build time : 2013-11-04 6:26:45 PM*/
KISSY.add("ajax/base",function(a,b,c,d){function e(b){var c=b.context;delete b.context,b=a.mix(a.clone(s),b,{deep:!0}),b.context=c||b;var e,f,g=b.type,h=b.dataType;return f=b.uri=p.resolve(b.url),b.uri.setQuery(""),"crossDomain"in b||(b.crossDomain=!b.uri.isSameOriginAs(p)),g=b.type=g.toUpperCase(),b.hasContent=!m.test(g),b.processData&&(e=b.data)&&"string"!=typeof e&&(b.data=a.param(e,d,d,b.serializeArray)),h=b.dataType=a.trim(h||"*").split(j),"cache"in b||!a.inArray(h[0],["script","jsonp"])||(b.cache=!1),b.hasContent||(b.data&&f.query.add(a.unparam(b.data)),b.cache===!1&&f.query.set("_ksTS",a.now()+"_"+a.guid())),b}function f(a,b){g.fire(a,{ajaxConfig:b.config,io:b})}function g(b){function c(a){return function(c){(k=d.timeoutTimer)&&(clearTimeout(k),d.timeoutTimer=0);var e=b[a];e&&e.apply(p,c),f(a,d)}}var d=this;if(!(d instanceof g))return new g(b);l.call(d),b=e(b),a.mix(d,{responseData:null,config:b||{},timeoutTimer:null,responseText:null,responseXML:null,responseHeadersString:"",responseHeaders:null,requestHeaders:{},readyState:0,state:0,statusText:null,status:0,transport:null,_defer:new a.Defer(this)});var i,j;f("start",d),i=r[b.dataType[0]]||r["*"],j=new i(d),d.transport=j,b.contentType&&d.setRequestHeader("Content-Type",b.contentType);var k,m,n=b.dataType[0],o=b.timeout,p=b.context,q=b.headers,s=b.accepts;d.setRequestHeader("Accept",n&&s[n]?s[n]+("*"===n?"":", */*; q=0.01"):s["*"]);for(m in q)d.setRequestHeader(m,q[m]);if(b.beforeSend&&b.beforeSend.call(p,d,b)===!1)return d;d.then(c("success"),c("error")),d.fin(c("complete")),d.readyState=1,f("send",d),b.async&&o>0&&(d.timeoutTimer=setTimeout(function(){d.abort("timeout")},1e3*o));var t=g.useMock;if(t)h(b,j.io);else try{d.state=1,j.send()}catch(u){d.state<2?(a.log(u.stack||u,"error"),d._ioReady(-1,u.message)):a.error(u)}return d}function h(b,c){var d=g.currentResponse;b.data||(b.data="");var e=b.dataType,f=a.isArray(e)&&"script"==e[0]&&"json"==e[1];d=g._getResponseUseData(d,b.data,f),c.status=d.status,c.responseText=d.responseText,c.mimeType=d.contentType,f&&g._setJsonpCallback(c,d),c._ioReady(d.status),g.resetCurrentResponse()}var i=/^(?:about|app|app\-storage|.+\-extension|file|widget)$/,j=/\s+/,k=function(a){return a},l=a.Promise,m=/^(?:GET|HEAD)$/,n=a.Env.host,o=n.location||{},p=new a.Uri(o.href),q=p&&i.test(p.getScheme()),r={},s={type:"GET",contentType:"application/x-www-form-urlencoded; charset=UTF-8",async:!0,serializeArray:!0,processData:!0,accepts:{xml:"application/xml, text/xml",html:"text/html",text:"text/plain",json:"application/json, text/javascript","*":"*/*"},converters:{text:{json:b.parse,html:k,text:k,xml:a.parseXML}},contents:{xml:/xml/,html:/html/,json:/json/}};return s.converters.html=s.converters.text,a.mix(g,c.Target),a.mix(g,{isLocal:q,setupConfig:function(b){a.mix(s,b,{deep:!0})},setupTransport:function(a,b){r[a]=b},getTransport:function(a){return r[a]},getConfig:function(){return s}}),a.mix(g,{currentResponse:[],useMock:!1,resetCurrentResponse:function(){return g.currentResponse=[]},install:function(b,c){if(!a.isString(b))return a.log("response\u7684url\u4e0d\u5b58\u5728\uff01"),!1;if(a.isArray(c)){var d=g.responses;a.each(c,function(a,b){c[b].contentType=a.responseHeaders||s.accepts.json}),d[b]=c}return d[b]},use:function(a,b){b&&"success"!=b||(b=200);var c=g.responses[a];return c?g.currentResponse=g._getResponse(c,b):!1},_getResponse:function(b,c){if(!b)return!1;var d=[];return a.isNumber(c)&&a.each(b,function(a){a.status==c&&d.push(a)}),d},_getResponseUseData:function(b,c,d){var e={},f=a.unparam(c);if(a.isEmptyObject(f))a.each(b,function(a){if(!a.data){if(!d)return e=a,!1;if(g._isJsonpResponse(a))return e=a,!1}});else{var h=!1;if(a.each(b,function(b){var f=a.param(b.data);if(f==c){if(!d)return e=b,h=!0,!1;if(g._isJsonpResponse(b))return e=b,h=!0,!1}}),!h)return g._getResponseUseData(b,"")}return e},_isJsonpResponse:function(a){var b=a.responseText;return/\(/.test(b)},_getJsonpCallbackName:function(a){var b=a.responseText;return b.split("(")[0]},_setJsonpCallback:function(b,c){var d=g._getJsonpCallbackName(c),e=b.converters=b.converters||{};e.script=e.script||{},e.script.json=function(){return{}},window[d]=function(c){arguments.length>1&&(c=a.makeArray(arguments)),b.responseData=c;var d=b._defer;d.resolve([c,"success",b])},g.jsonpCallback=d},responses:{}}),g},{requires:["json","event"]});